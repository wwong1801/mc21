<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>21点 · Player Turn (v0.2.0)</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <main class="table" aria-live="polite">
    <header class="bar">
      <h1>🃏 21点 · Player Turn</h1>

      <div class="bet">
        <label for="betInput">下注</label>
        <input id="betInput" type="number" min="1" step="1" value="100" style="width:90px" />
      </div>
      
      <div class="controls">
        <button id="newBtn" class="primary" title="N">新一局 (N)</button>
        <button id="hitBtn" title="H">要牌 (H)</button>
        <button id="standBtn" class="danger" title="S">不要 (S)</button>
      </div>
    </header>

    <section class="row">
      <div class="zone" id="dealerZone">
        <h2>庄家（隐藏）</h2>
        <div id="dealerHand" class="hand"></div>
        <div id="dealerTotal" class="total">点数：—（未公开）</div>
      </div>

      <div class="zone" id="playerZone">
        <h2>玩家</h2>
        <div id="playerHand" class="hand"></div>
        <div id="playerTotal" class="total">点数：0</div>
        <div id="banner" class="banner" hidden></div>
      </div>
    </section>
  </main>

  <!-- 🔊 Raw Sound Tests -->
  <div style="display:flex;gap:8px;margin:8px 0;">
    <button onclick="new Audio('./sounds/deal.mp3').play()">🔊 Raw Deal</button>
    <button onclick="new Audio('./sounds/win.mp3').play()">🔊 Raw Win</button>
    <button onclick="new Audio('./sounds/lose.mp3').play()">🔊 Raw Lose</button>
  </div>

  <!-- ✅ Firebase shared init + saveRound/testSave -->
  <script type="module">
    import { auth, db, ready } from "./src/multiplayer/firebase.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    await ready;

    console.log("✅ Firebase ready. UID =", auth.currentUser?.uid);
    document.title = "21点 · Player Turn (UID: " + auth.currentUser.uid.slice(0,6) + "…)";

    window.saveRound = async (round) => {
      try {
        const uid = auth.currentUser?.uid || null;
        await addDoc(collection(db, "rounds"), {
          uid,
          bet: round.bet,
          delta: round.delta,
          outcome: round.outcome,
          pt: round.pt,
          dt: round.dt,
          player: round.player,
          dealer: round.dealer,
          createdAt: serverTimestamp(),
        });
        console.log("✅ Round saved to Firestore");
      } catch (e) {
        console.error("❌ saveRound error", e);
      }
    };

    window.testSave = async () => {
      await window.saveRound?.({
        bet: 100, delta: +100, outcome: "TEST_WIN",
        pt: 21, dt: 18, player: ["A♠","K♦"], dealer: ["10♣","8♥"]
      });
      alert("✅ Test round saved (check Firestore/rounds).");
    };
  </script>

  <!-- 💬 Presence (optional) -->
  <script type="module">
    import { startPresence } from "./src/multiplayer/presence.js";
    startPresence();
  </script>

  <!-- 🌐 Public Room (anyone can join) -->
  <section id="publicMP" class="zone" style="margin:12px 0;">
    <h2>🌐 Public Multiplayer</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <span id="mpInfo">Joining…</span>
      <input id="mpBet" type="number" min="1" step="1" value="100" style="padding:8px;border-radius:8px;width:120px;">
      <button id="mpPlaceBet">Bet</button>
      <button id="mpStart">Start</button>
      <button id="mpDeal">Deal</button>
      <button id="mpHit">Hit</button>
      <button id="mpStand">Stand</button>
      <button id="mpSettle">Dealer+Settle</button>
    </div>
  </section>

  <!-- 🔄 Public Room Script -->
  <script type="module">
    import { ready, auth } from "./src/multiplayer/firebase.js";
    import { initPublicRoom, placeBet, startRound, dealInitial, hit, stand, dealerAndSettle } from "./src/multiplayer/public_room.js";

    const $ = (id) => document.getElementById(id);
    await ready;

    // Auto-join public room
    const { tableId, seatId } = await initPublicRoom("Player");
    $("mpInfo").textContent = `Table: ${tableId} · Your seat: ${seatId} · UID: ${auth.currentUser.uid.slice(0,6)}…`;

    $("mpPlaceBet").onclick = async () => {
      await placeBet(seatId, Number($("mpBet").value || 1));
      alert("Bet placed.");
    };
    $("mpStart").onclick  = async () => { await startRound(); };
    $("mpDeal").onclick   = async () => { await dealInitial(); };
    $("mpHit").onclick    = async () => { await hit(seatId); };
    $("mpStand").onclick  = async () => { await stand(seatId); };
    $("mpSettle").onclick = async () => { await dealerAndSettle(); };
  </script>

  <!-- 🧪 Firestore Test Button -->
  <button onclick="window.testSave()" style="margin:8px 0">Save TEST round</button>

  <!-- 🎮 Single-player Game -->
  <script type="module" src="./src/game.js"></script>
</body>
</html>
